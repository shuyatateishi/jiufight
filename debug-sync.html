<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”§ Firebase åŒæœŸãƒ‡ãƒãƒƒã‚° - Jiufight</title>
    <meta name="robots" content="noindex, nofollow">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .status-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #dee2e6;
        }
        .status-card.online {
            border-color: #28a745;
            background: #d4edda;
        }
        .status-card.offline {
            border-color: #dc3545;
            background: #f8d7da;
        }
        .log {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            border-radius: 8px;
            margin: 15px 0;
        }
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin: 8px;
            font-weight: 600;
        }
        .btn:hover {
            transform: translateY(-2px);
        }
        .btn-danger {
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
        }
        .data-display {
            background: #f1f3f4;
            padding: 15px;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”§ Firebase åŒæœŸãƒ‡ãƒãƒƒã‚°</h1>
            <p>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸã®å‹•ä½œçŠ¶æ³ã‚’è©³ç´°ã«ç›£è¦–ã—ã¾ã™</p>
        </div>

        <div class="status-grid">
            <div class="status-card" id="connection-status">
                <h3>ğŸ”— æ¥ç¶šçŠ¶æ…‹</h3>
                <div id="connection-info">ç¢ºèªä¸­...</div>
            </div>
            <div class="status-card" id="sync-status">
                <h3>ğŸ”„ åŒæœŸçŠ¶æ…‹</h3>
                <div id="sync-info">ç¢ºèªä¸­...</div>
            </div>
            <div class="status-card">
                <h3>ğŸ“Š ãƒ‡ãƒ¼ã‚¿çŠ¶æ…‹</h3>
                <div id="data-info">ç¢ºèªä¸­...</div>
            </div>
            <div class="status-card">
                <h3>ğŸ“± ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±</h3>
                <div id="device-info">ç¢ºèªä¸­...</div>
            </div>
        </div>

        <div>
            <h3>ğŸ§ª ãƒ†ã‚¹ãƒˆæ“ä½œ</h3>
            <button class="btn" onclick="testAddFighter()">ãƒ†ã‚¹ãƒˆé¸æ‰‹è¿½åŠ </button>
            <button class="btn" onclick="testEditFighter()">ãƒ†ã‚¹ãƒˆé¸æ‰‹ç·¨é›†</button>
            <button class="btn" onclick="forceSyncCheck()">å¼·åˆ¶åŒæœŸãƒã‚§ãƒƒã‚¯</button>
            <button class="btn" onclick="clearLog()">ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
            <button class="btn btn-danger" onclick="clearTestData()">ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿å‰Šé™¤</button>
        </div>

        <div>
            <h3>ğŸ“ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ­ã‚°</h3>
            <div id="debug-log" class="log"></div>
        </div>

        <div>
            <h3>ğŸ’¾ ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿</h3>
            <div id="current-data" class="data-display"></div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <!-- Firebase Configuration -->
    <script src="firebase-config.js"></script>
    
    <!-- Database Sync System -->
    <script src="database-sync.js"></script>

    <script>
        let debugLog = [];
        let monitorInterval;

        // Override console.log to capture logs
        const originalLog = console.log;
        const originalWarn = console.warn;
        const originalError = console.error;

        function captureLog(type, message, ...args) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message} ${args.join(' ')}`;
            debugLog.push(logEntry);
            updateLogDisplay();
            
            // Call original function
            if (type === 'log') originalLog(message, ...args);
            else if (type === 'warn') originalWarn(message, ...args);
            else if (type === 'error') originalError(message, ...args);
        }

        console.log = (...args) => captureLog('log', ...args);
        console.warn = (...args) => captureLog('warn', ...args);
        console.error = (...args) => captureLog('error', ...args);

        function updateLogDisplay() {
            const logElement = document.getElementById('debug-log');
            logElement.textContent = debugLog.slice(-50).join('\n');
            logElement.scrollTop = logElement.scrollHeight;
        }

        function updateStatus() {
            // Connection status
            const connectionElement = document.getElementById('connection-info');
            const connectionCard = document.getElementById('connection-status');
            
            if (typeof firebase === 'undefined') {
                connectionElement.innerHTML = 'âŒ Firebase SDK æœªèª­ã¿è¾¼ã¿';
                connectionCard.className = 'status-card offline';
            } else if (!window.firebaseDB) {
                connectionElement.innerHTML = 'âš ï¸ Firebase æœªåˆæœŸåŒ–';
                connectionCard.className = 'status-card offline';
            } else {
                connectionElement.innerHTML = 'âœ… Firebase æ¥ç¶šä¸­';
                connectionCard.className = 'status-card online';
            }

            // Sync status
            const syncElement = document.getElementById('sync-info');
            const syncCard = document.getElementById('sync-status');
            
            if (window.databaseSync) {
                const status = window.databaseSync.getSyncStatus();
                syncElement.innerHTML = `
                    çŠ¶æ…‹: ${status.isOnline ? 'âœ… ã‚ªãƒ³ãƒ©ã‚¤ãƒ³' : 'âŒ ã‚ªãƒ•ãƒ©ã‚¤ãƒ³'}<br>
                    ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹: ${status.hasDatabase ? 'âœ… æ¥ç¶šæ¸ˆã¿' : 'âŒ æœªæ¥ç¶š'}<br>
                    é¸æ‰‹æ•°: ${status.localCache.fighters}äºº<br>
                    ã‚­ãƒ¥ãƒ¼: ${status.syncQueue}ä»¶
                `;
                syncCard.className = status.isOnline && status.hasDatabase ? 'status-card online' : 'status-card offline';
            } else {
                syncElement.innerHTML = 'âŒ åŒæœŸã‚·ã‚¹ãƒ†ãƒ æœªåˆæœŸåŒ–';
                syncCard.className = 'status-card offline';
            }

            // Data info
            const dataElement = document.getElementById('data-info');
            const localData = JSON.parse(localStorage.getItem('fightersData') || '[]');
            dataElement.innerHTML = `
                ãƒ­ãƒ¼ã‚«ãƒ«é¸æ‰‹æ•°: ${localData.length}äºº<br>
                æœ€çµ‚æ›´æ–°: ${localStorage.getItem('fightersData_timestamp') ? 
                    new Date(parseInt(localStorage.getItem('fightersData_timestamp'))).toLocaleString() : 'æœªæ›´æ–°'}
            `;

            // Device info
            const deviceElement = document.getElementById('device-info');
            if (window.databaseSync) {
                const status = window.databaseSync.getSyncStatus();
                deviceElement.innerHTML = `
                    ãƒ‡ãƒã‚¤ã‚¹ID: ${status.deviceId}<br>
                    ãƒ–ãƒ©ã‚¦ã‚¶: ${navigator.userAgent.includes('Mobile') ? 'ãƒ¢ãƒã‚¤ãƒ«' : 'ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—'}<br>
                    ç”»é¢å¹…: ${window.innerWidth}px
                `;
            }

            // Current data display
            const currentDataElement = document.getElementById('current-data');
            currentDataElement.textContent = JSON.stringify(localData.slice(0, 3), null, 2);
        }

        function testAddFighter() {
            console.log('ğŸ§ª ãƒ†ã‚¹ãƒˆé¸æ‰‹ã‚’è¿½åŠ ä¸­...');
            
            if (!window.databaseSync) {
                console.error('âŒ Database sync not available');
                return;
            }

            const localData = JSON.parse(localStorage.getItem('fightersData') || '[]');
            const testFighter = {
                id: Date.now(),
                name: `ãƒ†ã‚¹ãƒˆé¸æ‰‹_${Date.now()}`,
                nickname: `ãƒ‡ãƒãƒƒã‚°å›_${new Date().getSeconds()}`,
                belt: 'blue',
                weight: 'light',
                dojo: 'ãƒ‡ãƒãƒƒã‚°é“å ´',
                wins: 999,
                losses: 0,
                bio: 'FirebaseåŒæœŸãƒ†ã‚¹ãƒˆç”¨ã®é¸æ‰‹',
                fullName: `ãƒ†ã‚¹ãƒˆå¤ªéƒ_${Date.now()}`,
                age: '25',
                testData: true
            };

            localData.push(testFighter);
            console.log(`â• ãƒ†ã‚¹ãƒˆé¸æ‰‹è¿½åŠ : ${testFighter.nickname}`);
            
            window.databaseSync.updateFighters(localData);
        }

        function testEditFighter() {
            console.log('ğŸ§ª ãƒ†ã‚¹ãƒˆé¸æ‰‹ã‚’ç·¨é›†ä¸­...');
            
            const localData = JSON.parse(localStorage.getItem('fightersData') || '[]');
            const testFighter = localData.find(f => f.testData);
            
            if (testFighter) {
                testFighter.motivation = `ç·¨é›†ãƒ†ã‚¹ãƒˆ - ${new Date().toLocaleTimeString()}`;
                testFighter.wins = testFighter.wins + 1;
                console.log(`âœï¸ ãƒ†ã‚¹ãƒˆé¸æ‰‹ç·¨é›†: ${testFighter.nickname}`);
                
                window.databaseSync.updateFighters(localData);
            } else {
                console.warn('âš ï¸ ãƒ†ã‚¹ãƒˆé¸æ‰‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }
        }

        function forceSyncCheck() {
            console.log('ğŸ”„ å¼·åˆ¶åŒæœŸãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ...');
            if (window.databaseSync) {
                window.databaseSync.forceSync();
            }
        }

        function clearTestData() {
            console.log('ğŸ—‘ï¸ ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤...');
            const localData = JSON.parse(localStorage.getItem('fightersData') || '[]');
            const filteredData = localData.filter(f => !f.testData);
            
            if (filteredData.length < localData.length) {
                window.databaseSync.updateFighters(filteredData);
                console.log(`âœ… ${localData.length - filteredData.length}ä»¶ã®ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤`);
            } else {
                console.log('â„¹ï¸ ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
            }
        }

        function clearLog() {
            debugLog = [];
            updateLogDisplay();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸš€ ãƒ‡ãƒãƒƒã‚°ãƒšãƒ¼ã‚¸é–‹å§‹');
            
            // Set up monitoring
            monitorInterval = setInterval(updateStatus, 1000);
            
            // Set up sync callback
            setTimeout(() => {
                if (window.databaseSync) {
                    window.databaseSync.onFighterUpdate((updatedData) => {
                        console.log(`ğŸ”” åŒæœŸé€šçŸ¥å—ä¿¡: ${updatedData.length}äººã®é¸æ‰‹ãƒ‡ãƒ¼ã‚¿`);
                        updateStatus();
                    });
                }
            }, 2000);
            
            updateStatus();
        });

        window.addEventListener('beforeunload', () => {
            if (monitorInterval) {
                clearInterval(monitorInterval);
            }
        });
    </script>
</body>
</html>